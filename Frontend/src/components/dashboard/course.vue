<template>
  <v-container fluid grid-list-xl fill-height>
    <v-layout justify-center>
      <v-flex xs12>
        <material-card color="general">
          <div slot="header">
            <div class="title font-weight-light mb-2">Courses</div>
          </div>
          <v-flex md12 sm12>
            <div>
              <v-dialog v-model="dialog" width="600px">
                <template v-slot:activator="{ on }">
                  <v-btn
                    v-if="userRole !== 'student'"
                    rounded
                    dark
                    class="general"
                    v-on="on"
                  >Add Course</v-btn>
                </template>
                <v-card>
                  <v-card-title>
                    <span class="headline">Create Course</span>
                  </v-card-title>
                  <v-card-text>
                    <v-container class="pt-0" grid-list-md>
                      <v-layout wrap>
                        <v-flex xs12 sm6 md6>
                          <v-text-field v-model="createContent.CourseCode" label="Course Code" />
                        </v-flex>

                        <v-flex xs12 sm6 md6>
                          <v-text-field v-model="createContent.CourseName" label="Course Name" />
                        </v-flex>

                        <v-flex xs12 sm12 md12>
                          <v-text-field
                            v-model="createContent.CourseDescription"
                            label="Course Description"
                          />
                        </v-flex>
                      </v-layout>
                    </v-container>
                  </v-card-text>
                  <v-card-actions>
                    <v-spacer />
                    <v-btn class="general" rounded dark @click="addCourse">Create</v-btn>
                  </v-card-actions>
                </v-card>
              </v-dialog>

              <v-dialog v-model="dialogleafNode" width="600px">
                <v-card>
                  <v-card-title class="headline">Create document</v-card-title>

                  <v-card-text>
                    <v-container class="pt-0" grid-list-md>
                      <v-layout wrap>
                        <v-flex xs12 sm12 md12>
                          <v-text-field
                            v-model="createMaterial.MaterialName"
                            label="document Name"
                          />
                        </v-flex>

                        <v-flex xs12 sm12 md12>
                          <v-text-field
                            v-model="createMaterial.MaterialDescription"
                            label="document Description"
                          />
                        </v-flex>
                      </v-layout>
                    </v-container>
                  </v-card-text>

                  <v-card-actions>
                    <v-spacer></v-spacer>

                    <v-btn class="general" rounded dark @click="addleafNode">Create</v-btn>
                  </v-card-actions>
                </v-card>
              </v-dialog>

              <vue-tree-list
                class="mt-3"
                :model="courseCodeTree"
                default-tree-node-name="new Course"
                default-leaf-node-name="new Content"
                :default-expanded="false"
                @change-name="onChangeName"
                @delete-node="deleteCourseCodeNode"
                @add-node="onAddNode"
              >
                <span slot="leafNodeIcon" class="icon">ðŸ“ƒ</span>
                <span slot="treeNodeIcon" class="icon">ðŸ“‚</span>
                <span slot class="icon">ðŸŒ²</span>
              </vue-tree-list>
            </div>
          </v-flex>
        </material-card>
      </v-flex>
    </v-layout>
  </v-container>
</template>

<script>
import axios from "axios";
import $ from "jquery";
import { VueTreeList, Tree, TreeNode } from "vue-tree-list";
export default {
  components: {
    VueTreeList
  },
  data() {
    return {
      courseCodeTree: new Tree([]),
      courses: [],
      courseContents: [],
      createContent: {},
      createMaterial: {},
      userId: "",
      userRole: "",
      dialog: false,
      dialogleafNode: false
    };
  },
  created() {
    //Pass user data from cookies
    this.userId = $cookies.get("userid");
    this.userRole = $cookies.get("role");

    //Check if the user role is a student or professor
    //Get User courses or All Course
    //Add the course to tree
    this.getUserCourses();
  },
  mounted: function() {
    let cur = this;
    cur.$nextTick(function() {
      setTimeout(function() {
        // Code that will run only after the
        // entire view has been rendered
        cur.addButton();
      }, 1000);
      //zconsole.log(this.courseContents.length);
    });
  },
  methods: {
    getUserCourses() {
      this.$store.dispatch("GETUSERCOURSES", this.userId).then(response => {
        this.courses = response.data;
        this.getCourseContent(this.userId);
      });
    },

    getCourseContent(userId) {
      this.$store.dispatch("GETUSERCONTENT", userId).then(response => {
        this.courseContents = response.data;
        this.addTreeNodeChildren();
      });
    },

    addTreeNodeChildren() {
      var node = {};
      for (var i = 0; i < this.courses.length; i++) {
        if (this.userRole === "student") {
          node = new TreeNode({
            //Set Default config for student
            isLeaf: false,
            dragDisabled: true,
            addTreeNodeDisabled: true,
            addLeafNodeDisabled: true,
            editNodeDisabled: true,
            delNodeDisabled: true
          });
        } else {
          node = new TreeNode({
            //Set Default config for student
            isLeaf: false,
            dragDisabled: true,
            addTreeNodeDisabled: true
          });
        }
        node.id = this.courses[i].courseId;
        node.name =
          this.courses[i].courseCode + " - " + this.courses[i].courseName;
        this.courseCodeTree.addChildren(node);
        this.addTreeNodeLeaf(this.courses[i].courseId, i);
      }
    },

    addTreeNodeLeaf(courseId, index) {
      for (var i = 0; i < this.courseContents.length; i++) {
        if (
          this.courseContents[i].courseId === courseId &&
          this.courseContents[i].type !== "announcement"
        ) {
          var nodeleaf;
          if (this.userRole === "student") {
            nodeleaf = new TreeNode({
              isLeaf: true,
              dragDisabled: true,
              addTreeNodeDisabled: true,
              addLeafNodeDisabled: true,
              editNodeDisabled: true,
              delNodeDisabled: true
            });
          } else {
            nodeleaf = new TreeNode({
              isLeaf: true,
              dragDisabled: true,
              addTreeNodeDisabled: true
            });
          }
          (nodeleaf.id = this.courseContents[i].contentId),
            (nodeleaf.name =
              this.courseContents[i].title +
              " | " +
              this.courseContents[i].description +
              " | " +
              this.courseContents[i].url+" | " );
          this.courseCodeTree.children[index].addChildren(nodeleaf);
        }
      }
    },

    addCourse() {
      let cur = this;
      this.createContent.CreatedBy = this.userId;
      if (this.userRole === "lecturer") {
        this.axios
          .post(
            "https://whiteboardsyetem.azurewebsites.net/createCourse?" +
              "CourseCode=" +
              this.createContent.CourseCode +
              "&CourseName=" +
              this.createContent.CourseName +
              "&CourseDescription=" +
              this.createContent.CourseDescription +
              "&CreatedBy=" +
              this.createContent.CreatedBy
          )
          .then(function(response) {
            var node = new TreeNode({
              id: response.data.courseId,
              name: response.data.courseCode + " - " + response.data.courseName,
              isLeaf: false,
              dragDisabled: true,
              addLeafNodeDisabled: true,
              editNodeDisabled: true
            });
            if (!cur.courseCodeTree.children) cur.courseCodeTree.children = [];
            cur.courseCodeTree.addChildren(node);
            cur.dialog = false;
            cur.createContent = {};
            cur.regLecturerToCourse(
              response.data.courseId,
              response.data.createdBy
            );
          });
      }
    },
    addButton() {
      var body = document.getElementsByClassName("vtl-operation");
      var contentBody = document.getElementsByClassName("vtl-node-content");
      var stringURL;
      var URL=[];
      var leafNodeLocation=[];
       for (var k = contentBody.length; k > 0; k--) {
         var innHTML=contentBody[k-1].innerHTML.trim();
      
          var l=innHTML.length;
          
         if(innHTML.charAt(l-1)=="|"){
          leafNodeLocation.push(k-1);
           for(var j=l-2; j > 0; j--)
           {
            if(innHTML.charAt(j)!="|"){
           if (j + 1 == l-2) {
                stringURL = innHTML.charAt(j);
              } else {
                stringURL = innHTML.charAt(j) + stringURL;
              }
            } else {
              URL.push(stringURL.trim());
              break;
            } 
           }
     
            
       }
      
       }

      for (var i = 0; i < leafNodeLocation.length; i++) {
        // 1. Create the button
        var button = document.createElement("button");
        button.setAttribute("id", "btn" + i);
        button.setAttribute("class", "general");
        button.innerHTML = "Download";
        button.style.color = "#ffffff";
        button.style.float = "right";

        // 2. Append somewhere
        $(body[leafNodeLocation[i]]).append(button);
      }
      // // 3. Add event handler
      $(document).ready(function() {
        for (var i = 0; i < leafNodeLocation.length; i++) {
          var btnID = "#btn" + i;
          var fileName;
          // URL =
           // "http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4";

          var fileTypeLength = 0;
          var longStringURL= URL[i];
          for (var v = longStringURL.length; v > 0; v--) {
            if (longStringURL[v] != "/") {
              if (v + 1 == longStringURL.length) {
                fileName = longStringURL[v];
              } else {
                fileName = longStringURL[v] + fileName;
              }
            } else {
              break;
            }
          }
          // onclick to perform download
          $(btnID).click(function() {
            axios({
              url: longStringURL,
              method: "GET",
              responseType: "blob" // important
            }).then(response => {
              console.log(response);
              var type = response.data.type;

              const url = window.URL.createObjectURL(new Blob([response.data]));
              const link = document.createElement("a");
              link.href = url;

              link.setAttribute("download", fileName);
              document.body.appendChild(link);
              link.click();
            });
          });
        }
      });
    },

    regLecturerToCourse(courseId, createdBy) {
      var item = {
        courseId: courseId,
        staffId: createdBy,
        isActive: true
      };
      this.$store.dispatch("ADDCOURSESTAFF", item);
    },

    deleteCourseCodeNode(node) {
      var answer = window.confirm("Confirm delete?");
      if (answer) {
        if (
          (node.name.charAt(0) === "C" || node.name.charAt(0) === "c") &&
          (node.name.charAt(1) === "Z" || node.name.charAt(1) === "z")
        ) {
          this.$store.dispatch("DELETECOURSE", node.id);
        } else {
          this.$store.dispatch("DELETECONTENT", node.id);
        }
        node.remove();
      }
    },

    onAddNode(params) {
      this.dialogleafNode = true;

      console.log(params.name);
    },
    addleafNode() {
      let cur = this;
      // var orgData = cur.courseCodeTree;
      // // first layer
      // for (var i = 0; i < orgData.children.length; i++) {
      //   // second layer
      //   for (var k = 0; k < orgData.children[i].children.length; k++) {
      //     if (params.id == orgData.children[i].children[k].id) {
      //       //edit the data from tree
      //       orgData.children[i].children[k].id = 1;
      //       orgData.children[i].children[k].name = "hihihi";
      //       orgData.children[i].children[k].pid = "hihihi";

      //       break;
      //     }
      //   }
      // }
      cur.createMaterial = {};
      cur.dialogleafNode = false;
    },

    addNode() {
      var node = new TreeNode({ name: "new node", isLeaf: false });
      if (!this.data.children) this.data.children = [];
      this.data.addChildren(node);
    },

    onChangeName(params) {
      var myObj = {
        contentId: params.id,
        courseId: params.id,
        type: "null",
        title: params.newName,
        description: "null",
        datetime: "0001-01-01T00:00:00Z",
        fileName: params.newName + ".doc",
        url: params.newName + ".doc",
        createdOn: "0001-01-01T00:00:00Z",
        createdBy: "d99dfc08-5d7a-4e04-c824-08d7c5959f4d"
      };
      this.axios
        .put("https://whiteboardsyetem.azurewebsites.net/updateContent", myObj)
        .then(function(response) {});
      console.log(params);
    }
  }
};
</script>
<style>
.vtl-node {
  padding: 1px !important;
  border-radius: 10px !important;
  border-color: #448aff;
  border-style: solid;
  border-width: 0.5px;
  margin-top: 10px !important;
  margin-bottom: 20px !important;
}

.vtl-node-main:hover {
  border-radius: 10px !important;
}
.vtl-node-content {
  padding: 10px !important;
  font-size: 18px !important;
}
button {
  margin-left: 10px;
  line-height: 60px;
  font-weight: bold;
  padding: 0 40px;
  background: #337ab7;
  border: #2e6da4;
  border-radius: 1px;
}
button:hover {
  color: #fff;
  background: #337ab7;
  border-radius: 25px;
}
</style>
